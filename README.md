# üé• Video Processing Server

–°–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –¥–∞–π–≤–∏–Ω–≥–∞.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
cp server_config.example.json server_config.json
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ server_config.json —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
```bash
./deploy_optimized.sh
```

3. **–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:**
```bash
./deploy_update.sh
```

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements_server.txt):
- Python 3.12+
- FastAPI 0.104.1
- Uvicorn 0.24.0
- OpenCV 4.8.0+
- NumPy 1.24.0+
- Pydantic 2.5.0
- psutil 5.9.0+

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (src/requirements.txt):
- SQLAlchemy 2.0.23 (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- Redis 5.0.1 (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
- Celery 5.3.4 (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
- CuPy CUDA 12.3.0 (GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ)
- Gunicorn 21.2.0 (WSGI —Å–µ—Ä–≤–µ—Ä)

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Nginx (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- Redis (–¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—á–µ—Ä–µ–¥–µ–π)

## üîß API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ
- `GET /` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- `GET /health` - –°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è
- `GET /docs` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (Swagger UI)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
- `POST /api/process/image` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `POST /api/process/video` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
- `GET /api/download/{filename}` - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- `GET /api/files` - –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
- `DELETE /api/files/{filename}` - –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### –ú–æ–±–∏–ª—å–Ω—ã–π API
- `GET /api/mobile/status` - –°—Ç–∞—Ç—É—Å –º–æ–±–∏–ª—å–Ω–æ–≥–æ API
- `GET /api/mobile/health` - –ó–¥–æ—Ä–æ–≤—å–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ API
- `POST /api/mobile/process/image` - –ú–æ–±–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `POST /api/mobile/process/video` - –ú–æ–±–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
- `GET /api/mobile/files` - –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- `GET /api/performance/info` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `POST /api/performance/configure` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫:

- **Batch size**: —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–æ–≤
- **Max processes**: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- **Video quality**: –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –≤–∏–¥–µ–æ (1-100%)
- **GPU**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GPU —É—Å–∫–æ—Ä–µ–Ω–∏—è (CUDA, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- **Auto configure**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **FFmpeg optimization**: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ

### –ü—Ä–æ—Ñ–∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:
- **LOW_END**: 2 CPU, 2GB RAM ‚Üí batch=16, proc=2, quality=75%
- **STANDARD**: 4 CPU, 8GB RAM ‚Üí batch=48, proc=3, quality=80%
- **MID_RANGE**: 8 CPU, 16GB RAM ‚Üí batch=96, proc=6, quality=85%
- **HIGH_END**: 16+ CPU, 32+ GB RAM ‚Üí batch=128, proc=16, quality=90%

### GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ:
- **CuPy CUDA 12.3.0**: –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ GPU
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –Ω–∞–ª–∏—á–∏—è CUDA
- **Fallback –Ω–∞ CPU**: –µ—Å–ª–∏ GPU –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–º

### –ö–æ–º–∞–Ω–¥—ã systemd:
```bash
systemctl status video-server    # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
systemctl restart video-server   # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
systemctl stop video-server      # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
systemctl start video-server     # –ó–∞–ø—É—Å–∫
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /opt/video-server
source venv/bin/activate
python scripts/performance_monitor.py
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
python scripts/remote_server_optimizer.py
python scripts/set_quality_profile.py list
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
pythonServer/
‚îú‚îÄ‚îÄ app.py                     # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ deploy_optimized.sh        # –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ deploy_update.sh           # –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ .deployignore              # –ò—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏
‚îú‚îÄ‚îÄ requirements_server.txt    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ server_config.json         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ performance_config.json    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ src/                       # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ api/                   # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ config/                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ dive_color_corrector/  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
‚îÇ   ‚îú‚îÄ‚îÄ models/                # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ services/              # –°–µ—Ä–≤–∏—Å—ã
‚îú‚îÄ‚îÄ scripts/                   # –°–∫—Ä–∏–ø—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ auto_setup_server.py
‚îÇ   ‚îú‚îÄ‚îÄ performance_monitor.py
‚îÇ   ‚îú‚îÄ‚îÄ remote_server_optimizer.py
‚îÇ   ‚îú‚îÄ‚îÄ set_quality_profile.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ tests/                     # –¢–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ uploads/                   # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

## üåê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ò–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Üí Nginx (–ø–æ—Ä—Ç—ã 80/443) ‚Üí FastAPI (–ø–æ—Ä—Ç 8080) ‚Üí Redis (–ø–æ—Ä—Ç 6379)
```

- **Nginx**: reverse proxy, SSL —Ç–µ—Ä–º–∏–Ω–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
- **FastAPI**: API —Å–µ—Ä–≤–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
- **Redis**: –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á, —Å–µ—Å—Å–∏–∏
- **Systemd**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- **Docker**: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Nginx –∫–∞–∫ reverse proxy —Å SSL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- –§–∞–π—Ä–≤–æ–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø–æ—Ä—Ç—ã 22, 80, 443)
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ä–µ–¥–∞ Python (venv)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ –ø–∞–ø–∫–µ `docker/ssl/`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏:
```bash
journalctl -u video-server -f    # –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
journalctl -u nginx -f          # –õ–æ–≥–∏ nginx
```

### –ú–µ—Ç—Ä–∏–∫–∏:
- CPU, RAM, –¥–∏—Å–∫ —á–µ—Ä–µ–∑ `psutil`
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `server_config.example.json` –≤ `server_config.json`
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–µ—Ä–∞
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `./deploy_optimized.sh`

### Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:
```bash
cd docker/
docker-compose up -d
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏:
1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)
3. –°–æ–∑–¥–∞–Ω–∏–µ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
6. –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
8. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

## üìù –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### –í–∏–¥–µ–æ:
- MP4, AVI, MOV, MKV, WMV, FLV, WebM

### –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
- JPG, JPEG, PNG, BMP

## üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** –ø–æ–¥ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
- **–ú–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
- **GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ** (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- **–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ü–≤–µ—Ç–æ–≤** –¥–ª—è –ø–æ–¥–≤–æ–¥–Ω–æ–π —Å—ä–µ–º–∫–∏
- **REST API** —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **–ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `journalctl -u video-server`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `systemctl status video-server`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ nginx: `systemctl status nginx`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API: `curl http://your-server/health`