#!/bin/bash

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
# ÐÐ²Ñ‚Ð¾Ñ€: AI Assistant
# Ð”Ð°Ñ‚Ð°: 10 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ 2025

set -e

echo "ðŸš€ ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—Ð˜Ð ÐžÐ’ÐÐÐÐžÐ• Ð ÐÐ—Ð’Ð•Ð Ð¢Ð«Ð’ÐÐÐ˜Ð•"
echo "=================================="

# Ð¦Ð²ÐµÑ‚Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_step() {
    echo -e "${BLUE}ðŸ”§ $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [ ! -f "server_config.json" ]; then
    print_error "Ð¤Ð°Ð¹Ð» server_config.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    exit 1
fi

# Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
HOST=$(grep -o '"host": "[^"]*"' server_config.json | cut -d'"' -f4)
USERNAME=$(grep -o '"username": "[^"]*"' server_config.json | cut -d'"' -f4)
SSH_KEY=$(grep -o '"ssh_key_path": "[^"]*"' server_config.json | cut -d'"' -f4)

print_info "Ð¡ÐµÑ€Ð²ÐµÑ€: $HOST"
print_info "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $USERNAME"
print_info "SSH ÐºÐ»ÑŽÑ‡: $SSH_KEY"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ SSH ÐºÐ»ÑŽÑ‡ (Ñ€Ð°ÑÑˆÐ¸Ñ€ÑÐµÐ¼ ~)
SSH_KEY_EXPANDED="${SSH_KEY/#\~/$HOME}"
if [ ! -f "$SSH_KEY_EXPANDED" ]; then
    print_error "SSH ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $SSH_KEY_EXPANDED"
    exit 1
fi
SSH_KEY="$SSH_KEY_EXPANDED"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
run_remote() {
    local cmd="$1"
    local desc="$2"
    
    if [ -n "$desc" ]; then
        print_step "$desc"
    fi
    
    ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$USERNAME@$HOST" "$cmd"
    
    if [ $? -eq 0 ]; then
        if [ -n "$desc" ]; then
            print_status "$desc - ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        fi
        return 0
    else
        if [ -n "$desc" ]; then
            print_error "$desc - Ð¾ÑˆÐ¸Ð±ÐºÐ°"
        fi
        return 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ..."
if ! run_remote "echo 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾'" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ"; then
    print_error "ÐÐµ ÑƒÐ´Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
PYTHON_VERSION=$(run_remote "python3 --version" "")
if [ $? -eq 0 ]; then
    print_status "Python Ð½Ð°Ð¹Ð´ÐµÐ½: $PYTHON_VERSION"
else
    print_error "Python3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ"
    exit 1
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
print_info "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
run_remote "apt update && apt install -y python3-pip python3-venv ffmpeg build-essential libssl-dev libffi-dev git rsync" "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
print_info "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
run_remote "mkdir -p /opt/video-server" "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÐ¼Ð¸
print_info "ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
print_step "Ð˜ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¸ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð´Ð»Ñ rsync
EXCLUDE_FILE=$(mktemp)
cat > "$EXCLUDE_FILE" << 'EOF'
# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
server_config.json
.env
.env.local
.env.production

# Python ÐºÑÑˆ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Virtual environments
venv/
env/
ENV/
env.bak/
venv.bak/

# IDE Ñ„Ð°Ð¹Ð»Ñ‹
.vscode/
.idea/
*.swp
*.swo
*~

# OS Ñ„Ð°Ð¹Ð»Ñ‹
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Ð›Ð¾Ð³Ð¸
*.log
logs/
app.log

# Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
uploads/
outputs/
temp/
tests/*.mp4
tests/*.avi
tests/*.mov

# Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
*.db
*.sqlite
*.sqlite3

# Docker Ñ„Ð°Ð¹Ð»Ñ‹
Dockerfile
docker-compose.yml
.dockerignore
docker/

# Backup Ñ„Ð°Ð¹Ð»Ñ‹
backup/
*.bak
*.backup

# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
tmp/
temp/
*.tmp

# Git Ñ„Ð°Ð¹Ð»Ñ‹
.git/
.gitignore
.gitattributes

# Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ README)
*.md
!README.md

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
scripts/gpu_optimization_test.py
scripts/performance_test.py
scripts/quick_performance_test.py
scripts/simple_quality_test.py
scripts/test_quality.py
scripts/monitor_performance.py

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
config_profiles.json
quality_profiles.json
performance_config.py

# ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·
*_REPORT.md
*_ANALYSIS.md
*_FIX_REPORT.md
*_GUIDE.md
*_SUCCESS_REPORT.md

# Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ñ‹
*.mp4
*.avi
*.mov
*.mkv
*.wmv
*.flv
*.webm

# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
server_setup_config.json
server_optimization_config.json
logging_config.json
start_server.sh

# Makefile
Makefile

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ
deploy*.sh
deploy*.py
EOF

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÐ¼Ð¸
rsync -avz --delete \
    --exclude-from="$EXCLUDE_FILE" \
    -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
    ./ "$USERNAME@$HOST:/opt/video-server/"

if [ $? -eq 0 ]; then
    print_status "Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ (Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÐ¼Ð¸)"
else
    print_error "ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²"
    rm -f "$EXCLUDE_FILE"
    exit 1
fi

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
rm -f "$EXCLUDE_FILE"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
print_info "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹..."
run_remote "chmod +x /opt/video-server/scripts/*.py" "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²"

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
print_info "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
run_remote "cd /opt/video-server && python3 -m venv venv && source venv/bin/activate && pip install --upgrade pip && pip install -r requirements_server.txt" "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ
print_info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ..."
run_remote "cd /opt/video-server && source venv/bin/activate && python3 scripts/auto_setup_server.py --skip-deps" "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°"

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
print_info "ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸..."
run_remote "cd /opt/video-server && source venv/bin/activate && python3 scripts/remote_server_optimizer.py --skip-test" "ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº..."
run_remote "cd /opt/video-server && source venv/bin/activate && python3 -c 'from src.dive_color_corrector.mobile_correct import get_performance_info; import json; print(\"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:\", json.dumps(get_performance_info(), indent=2))'" "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
print_info "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
run_remote "cat > /etc/systemd/system/video-server.service << 'EOF'
[Unit]
Description=Video Processing Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/video-server
ExecStart=/opt/video-server/venv/bin/python app.py
Restart=always
RestartSec=10
Environment=PYTHONPATH=/opt/video-server/src

[Install]
WantedBy=multi-user.target
EOF" "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°"

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ
print_info "Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ..."
run_remote "systemctl daemon-reload && systemctl enable video-server && systemctl start video-server" "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°"

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
print_info "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº..."
run_remote "systemctl restart video-server && sleep 3" "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ nginx
print_info "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ nginx..."
run_remote "apt install -y nginx" "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° nginx"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx
print_info "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx..."
run_remote "cat > /etc/nginx/sites-available/video-server << 'EOF'
# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
client_max_body_size 500M;
client_body_timeout 300s;
client_header_timeout 300s;
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;
send_timeout 300s;

upstream video_api {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://video_api;
        proxy_set_header Host \\\$host;
        proxy_set_header X-Real-IP \\\$remote_addr;
        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \\\$scheme;
        
        # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }

    location /health {
        proxy_pass http://video_api/health;
        access_log off;
    }
}
EOF" "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx"

# ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx
print_info "ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx..."
run_remote "ln -sf /etc/nginx/sites-available/video-server /etc/nginx/sites-enabled/ && rm -f /etc/nginx/sites-enabled/default && nginx -t" "ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ nginx"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx
print_info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx..."
run_remote "systemctl start nginx && systemctl enable nginx" "Ð—Ð°Ð¿ÑƒÑÐº nginx"

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»
print_info "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»..."
run_remote "ufw allow 22/tcp && ufw allow 80/tcp && ufw --force enable" "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°..."
STATUS=$(run_remote "systemctl status video-server --no-pager" "")
echo "$STATUS"

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
print_info "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº..."
run_remote "cd /opt/video-server && source venv/bin/activate && python3 -c 'from src.dive_color_corrector.mobile_correct import get_performance_info; import json; info = get_performance_info(); print(f\"âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹: batch={info[\"batch_size\"]}, proc={info[\"max_processes\"]}, quality={info[\"video_quality\"]}%\")'" "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ API
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ API..."
API_RESPONSE=$(run_remote "curl -s http://localhost/health" "")
if [ $? -eq 0 ]; then
    print_status "API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚: $API_RESPONSE"
else
    print_warning "API Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
print_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
NGINX_CONFIG=$(run_remote "grep -c 'client_max_body_size 500M' /etc/nginx/sites-available/video-server" "")
if [ "$NGINX_CONFIG" -gt 0 ]; then
    print_status "Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð¾ 500MB"
else
    print_warning "Nginx Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²"
fi

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ð¸
echo ""
echo "ðŸŽ‰ ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—Ð˜Ð ÐžÐ’ÐÐÐÐžÐ• Ð ÐÐ—Ð’Ð•Ð Ð¢Ð«Ð’ÐÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž!"
echo "============================================="
echo "ðŸŒ Ð¡ÐµÑ€Ð²ÐµÑ€: $HOST"
echo "ðŸ”— API: http://$HOST"
echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://$HOST/docs"
echo ""
echo "ðŸ“‹ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:"
echo "  ssh -i $SSH_KEY $USERNAME@$HOST"
echo "  systemctl status video-server"
echo "  systemctl restart video-server"
echo "  systemctl stop video-server"
echo ""
echo "ðŸ“Š ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:"
echo "  cd /opt/video-server"
echo "  source venv/bin/activate"
echo "  python scripts/performance_monitor.py"
echo ""
echo "âš™ï¸ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ:"
echo "  python scripts/remote_server_optimizer.py"
echo "  python scripts/set_quality_profile.py list"
echo "============================================="

print_status "ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
